---
title: "Yeast Report"
author: "Zebulun Arendsee"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Yeast Report}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE, message=FALSE}
# # uncomment to run the analysis
# document()
# # library(fagin)
# library(rmonad)
# library(ggplot2)
# library(knitr)
# library(dplyr)
# library(magrittr)
# require(CNEr)
# require(GenomicRanges)
# con <- config()
# file.symlink("../inst/yeast", "INPUT")
# # file.symlink("/db/fagin-input/brassicaceae", "INPUT")
# # con@input@focal_species = "Arabidopsis_thaliana"
# # con@synder@offsets = c(0L,1L) # offsets for Satsuma
# con@synder@offsets = c(1L,1L) # offsets for Satsuma
# d <- run_fagin(con)
# missues(d) %>% kable(format='html') %>% write('ARCHIVE/issues.html')
# mtabulate(d, code=TRUE) %>% kable(format='html') %>% write('ARCHIVE/table.html')
# ms <- as.list(d)
# es <- ms[sapply(ms, function(x) x$has_error())]
# ws <- ms[sapply(ms, function(x) x$has_warnings())]
```

```{r, echo=FALSE}
# uncomment to build a vignette based off the archived data
library(fagin)
library(rmonad)
library(ggplot2)
library(knitr)
library(dplyr)
library(magrittr)
require(CNEr)
require(GenomicRanges)
con <- config()
con@synder@offsets = c(1L,1L) # offsets for Satsuma
```

## Input data summary

```{r, echo=FALSE}
load('ARCHIVE/d1.Rda')
ss <- invertSummaries(d1)
```

```{r, fig.width=6, fig.height=4, echo=FALSE, message=FALSE}
require(ape)
plot(d1@tree)
speciesOrder <- d1@tree$tip.label
```

```{r, echo=FALSE, result='asis'}
nscaf <- number_of_chromosomes(ss)
initialRes <- initial_protein_residue_counts(ss)
finalRes <- final_protein_residue_counts(ss)
hasStop <- protein_has_internal_stop(ss)
genComp <- genomic_composition(ss)
data.frame(
    species = names(nscaf) %>% factor(levels=speciesOrder)
  , scafs = nscaf %>% unlist %>% unname
  , bases = sapply(ss$dna, function(x) x@table$length %>% sum)
  , prots = sapply(initialRes, sum) %>% unname
  , GC = sapply(genComp, function(x) ((x['G'] + x['C']) * 100) %>% round)
  , oddstart = sapply(initialRes, function(x) { sum(x) - x['M'] }) %>% unname
  , oddstop = sapply(finalRes, function(x) { sum(x) - x['*'] }) %>% unname
  , p_N = sapply(genComp, function(x) x['N'] %>% signif(3))
  , n_stop = hasStop %>% unlist %>% unname
) %>%
    dplyr::arrange(species) %>%
    knitr::kable(caption="**Genomic statistics**. *scafs* - number of scaffolds in the genome. *bases* - total number of bases in the genome. *prots* - total number of protein coding models. *GC* - the percent of G and C nucleotides in the genome. *oddstart* - number of coding sequences that do not begin with M. *oddstop* - number of coding sequences that do not end with a stop (\\*). *p_N* - number of unknown nucleotides (N) in the genome. *n_stop* - number of coding sequences with an internal stop.")
```

```{r, echo=FALSE, result='asis'}
num_sum_as_table <- function(nd){
    data.frame(
        min    = sapply(nd, function(x) x@min)
      , q25    = sapply(nd, function(x) x@q25)
      , median = sapply(nd, function(x) x@median)
      , q75    = sapply(nd, function(x) x@q75)
      , max    = sapply(nd, function(x) x@max)
      , mean   = sapply(nd, function(x) x@mean)
      , sd     = sapply(nd, function(x) x@sd)
      , n      = sapply(nd, function(x) x@n)
    )
}

d1@synmaps %>%
    lapply(function(x) x@synmap.summary@width) %>%
    num_sum_as_table %>%
    knitr::kable(caption="Lengths of homologous links in each synteny map.")
```

## `synder` output

```{r, echo=FALSE, results='asis'}
load('ARCHIVE/d2.Rda')

summarize_sis <- function(xs, label){
  lapply(xs, function(x){
     x$si %>%
         CNEr::second() %>%
         GenomicRanges::width() %>%
         fagin::summarize_numeric()
   }) %>%
     num_sum_as_table %>%
     { .$group = label; . }
}

qsissum <- summarize_sis(d2$query, "orphan"),
tsissum <- summarize_sis(d2$control, "control")

# FIXME: The following relationship should always hold. The fact that it does
# hold is a bit dubious, since it is not usually good to hold multiple copies
# of data.
stopifnot(qsissum == tsissum)

qsissum %>%
  knitr::kable(caption="Search interval widths")
```

## Fagin output

```{r, fig.width=8, fig.height=6, echo=FALSE}
plotSecondaryLabels(con)
```

```{r, fig.width=8, fig.height=4, echo=FALSE}
plotSecondaryLabels(con, fill='species')
```

## Origin classifications

**TODO - fill this out**

## System info

**TODO - dump the collected session info here**
